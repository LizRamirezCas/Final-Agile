-- =========================================================
-- 1. CONFIGURACIÓN DE LA TABLA (DATOS)
-- =========================================================

-- Limpieza previa por si acaso
DROP TABLE IF EXISTS "public"."debts";

-- Creación de la tabla
CREATE TABLE "public"."debts" (
    "id"              bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "user_id"         uuid REFERENCES auth.users NOT NULL,
    "email_usuario"   text NOT NULL,
    "nombre"          text NOT NULL,
    "monto"           numeric(10, 2) NOT NULL,
    "tasa_interes"    numeric,
    "numero_meses"    integer,
    "fecha"           date NOT NULL,
    "pagado"          boolean DEFAULT false NOT NULL,
    "created_at"      timestamp with time zone DEFAULT now() NOT NULL,
    
    -- COLUMNAS PARA EL PAGO
    "metodo_pago"     text,
    "fecha_pago_real" timestamp with time zone,
    "comprobante_url" text, -- Aquí va el link de la foto

    -- Restricción para evitar duplicados exactos
    CONSTRAINT "unique_debt_per_user_and_date" UNIQUE ("user_id", "nombre", "fecha")
);

-- Activar seguridad (RLS)
ALTER TABLE "public"."debts" ENABLE ROW LEVEL SECURITY;

-- Política de acceso a datos (Solo el dueño ve sus deudas)
CREATE POLICY "Permitir todo al dueño" 
ON "public"."debts"
FOR ALL
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id);


-- =========================================================
-- 2. CONFIGURACIÓN DE PERMISOS PARA FOTOS (STORAGE)
-- =========================================================

-- Borrar políticas viejas si existen para evitar conflictos
DROP POLICY IF EXISTS "Subida comprobantes autenticados" ON storage.objects;
DROP POLICY IF EXISTS "Ver comprobantes publicos" ON storage.objects;

-- Política 1: Permitir a cualquier usuario logueado subir archivos al bucket 'comprobantes'
CREATE POLICY "Subida comprobantes autenticados"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK ( bucket_id = 'comprobantes' );

-- Política 2: Permitir ver los archivos (Lectura pública)
CREATE POLICY "Ver comprobantes publicos"
ON storage.objects FOR SELECT
TO public
USING ( bucket_id = 'comprobantes' );